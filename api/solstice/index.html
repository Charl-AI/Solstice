
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Solstice is a library for scaling deep learning experiments in JAX.">
      
      
        <meta name="author" content="Charles Jones">
      
      
      <link rel="icon" href="../../solstice_summer_logo.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.9">
    
    
      
        <title>solstice - Solstice</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../css/style.css">
    
      <link rel="stylesheet" href="../../css/material.css">
    
      <link rel="stylesheet" href="../../css/mkdocstrings.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="amber">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#whole-api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Solstice" class="md-header__button md-logo" aria-label="Solstice" data-md-component="logo">
      
  <img src="../../solstice_summer_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Solstice
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              solstice
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="amber"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Charl-AI/Solstice" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    Charl-AI/Solstice
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Solstice" class="md-nav__button md-logo" aria-label="Solstice" data-md-component="logo">
      
  <img src="../../solstice_summer_logo.png" alt="logo">

    </a>
    Solstice
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Charl-AI/Solstice" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    Charl-AI/Solstice
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../primer/" class="md-nav__link">
        Primer - Background and Concepts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../from_flax_to_solstice/" class="md-nav__link">
        From flax to solstice
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          solstice
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        solstice
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#whole-api" class="md-nav__link">
    Whole API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#experiments" class="md-nav__link">
    Experiments
  </a>
  
    <nav class="md-nav" aria-label="Experiments">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#solstice.experiment.Experiment" class="md-nav__link">
    Experiment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    Metrics
  </a>
  
    <nav class="md-nav" aria-label="Metrics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#solstice.metrics.Metrics" class="md-nav__link">
    Metrics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solstice.metrics.ClassificationMetrics" class="md-nav__link">
    ClassificationMetrics
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training" class="md-nav__link">
    Training
  </a>
  
    <nav class="md-nav" aria-label="Training">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#solstice.trainer.Callback" class="md-nav__link">
    Callback
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solstice.trainer.LoggingCallback" class="md-nav__link">
    LoggingCallback
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solstice.trainer.CheckpointingCallback" class="md-nav__link">
    CheckpointingCallback
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solstice.trainer.ProfilingCallback" class="md-nav__link">
    ProfilingCallback
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solstice.trainer.EarlyStoppingCallback" class="md-nav__link">
    EarlyStoppingCallback
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solstice.trainer.train" class="md-nav__link">
    train()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solstice.trainer.test" class="md-nav__link">
    test()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utilities" class="md-nav__link">
    Utilities
  </a>
  
    <nav class="md-nav" aria-label="Utilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#solstice.utils.EarlyStoppingException" class="md-nav__link">
    EarlyStoppingException
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solstice.utils.replace" class="md-nav__link">
    replace()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5">
          Miscellaneous
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Miscellaneous" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Miscellaneous
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../example_projects/" class="md-nav__link">
        Examples
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../parallelism_strategies/" class="md-nav__link">
        Parallelism Strategies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#whole-api" class="md-nav__link">
    Whole API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#experiments" class="md-nav__link">
    Experiments
  </a>
  
    <nav class="md-nav" aria-label="Experiments">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#solstice.experiment.Experiment" class="md-nav__link">
    Experiment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    Metrics
  </a>
  
    <nav class="md-nav" aria-label="Metrics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#solstice.metrics.Metrics" class="md-nav__link">
    Metrics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solstice.metrics.ClassificationMetrics" class="md-nav__link">
    ClassificationMetrics
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training" class="md-nav__link">
    Training
  </a>
  
    <nav class="md-nav" aria-label="Training">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#solstice.trainer.Callback" class="md-nav__link">
    Callback
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solstice.trainer.LoggingCallback" class="md-nav__link">
    LoggingCallback
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solstice.trainer.CheckpointingCallback" class="md-nav__link">
    CheckpointingCallback
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solstice.trainer.ProfilingCallback" class="md-nav__link">
    ProfilingCallback
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solstice.trainer.EarlyStoppingCallback" class="md-nav__link">
    EarlyStoppingCallback
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solstice.trainer.train" class="md-nav__link">
    train()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solstice.trainer.test" class="md-nav__link">
    test()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utilities" class="md-nav__link">
    Utilities
  </a>
  
    <nav class="md-nav" aria-label="Utilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#solstice.utils.EarlyStoppingException" class="md-nav__link">
    EarlyStoppingException
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solstice.utils.replace" class="md-nav__link">
    replace()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


  <h1>solstice</h1>

<div class="doc doc-object doc-module">



  <div class="doc doc-contents first">
  
      <p>Solstice, a library for creating and scaling experiments in JAX.</p>

  

  <div class="doc doc-children">











  </div>

  </div>

</div><hr />
<h2 id="whole-api">Whole API<a class="headerlink" href="#whole-api" title="Permanent link">¤</a></h2>
<div class="admonition abstract">
<p class="admonition-title">Abstract</p>
<p>This is all of Solstice. Everything is accessible through the <code>solstice.*</code> namespace.
</p>
<div class="mkdocstrings">

<div class="doc doc-object doc-attribute">



<h4 id="solstice.__all__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">solstice</span><span class="o">.</span><span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;Metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;ClassificationMetrics&#39;</span><span class="p">,</span> <span class="s1">&#39;Callback&#39;</span><span class="p">,</span> <span class="s1">&#39;CheckpointingCallback&#39;</span><span class="p">,</span> <span class="s1">&#39;EarlyStoppingCallback&#39;</span><span class="p">,</span> <span class="s1">&#39;LoggingCallback&#39;</span><span class="p">,</span> <span class="s1">&#39;ProfilingCallback&#39;</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="s1">&#39;EarlyStoppingException&#39;</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#solstice.__all__" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents first">
  </div>

</div><h4 class="doc doc-heading" data-role="data" id="solstice.__all__"><a class="headerlink" href="#solstice.__all__" title="Permanent link">¤</a></h4>
</div>
</div>
<hr />
<h2 id="experiments">Experiments<a class="headerlink" href="#experiments" title="Permanent link">¤</a></h2>


<div class="doc doc-object doc-module">



  <div class="doc doc-contents first">
  
      <p>The <code>Experiment</code> is at the heart of Solstice. The API is similar to the
<code>pl.LightningModule</code> loved by
<a href="https://pytorch-lightning.readthedocs.io/en/latest/">PyTorch-Lightning</a> users, but we
do less 'magic' to keep it as transparent as possible. If in doubt, just read the source
code - it's really short!</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="solstice.experiment.Experiment" class="doc doc-heading">
        <code>Experiment</code>


<a href="#solstice.experiment.Experiment" class="headerlink" title="Permanent link">¤</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="equinox">eqx</span>.<span title="equinox.Module">Module</span></code>, <code><span title="abc.ABC">ABC</span></code></p>

  
      <p>Base class for Solstice experiments.</p>
<p>An Experiment holds all stateful models, optimizers, etc... for a run and
implements this interface. To make your own experiments, subclass this class and
implement the logic for initialisation, training, and evaluating.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>This is a subclass of <code>equinox.Module</code>, so you are free to use pure JAX
transformations such as <code>jax.jit</code> and <code>jax.pmap</code>, as long as you remember to
filter out static PyTree fields (e.g. with <code>eqx.filter_jit</code>).</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Pseudocode for typical <code>Experiment</code> usage:
<div class="highlight"><pre><span></span><code><span class="n">exp</span> <span class="o">=</span> <span class="n">MyExperiment</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># initialise experiment state</span>

<span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
    <span class="n">exp</span><span class="p">,</span> <span class="n">outs</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
    <span class="c1">#do anything with the outputs here</span>

<span class="c1"># exp is just a pytree, so we can save and restore checkpoints like so...</span>
<span class="n">equinox</span><span class="o">.</span><span class="n">tree_serialise_leaves</span><span class="p">(</span><span class="s2">&quot;checkpoint_0.eqx&quot;</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
</code></pre></div></p>
</div>
<p>This class just specifies a recommended interface for experiment code. Experiments
implementing this interface will automatically work with the Solstice training
loops. You can always create or override methods as you wish and no methods are
special-cased. For example it is common to define a <code>__call__</code> method to perform
inference on a batch of data.</p>


        <details class="quote">
          <summary>Source code in <code>solstice/experiment.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Experiment</span><span class="p">(</span><span class="n">eqx</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for Solstice experiments.</span>

<span class="sd">    An Experiment holds all stateful models, optimizers, etc... for a run and</span>
<span class="sd">    implements this interface. To make your own experiments, subclass this class and</span>
<span class="sd">    implement the logic for initialisation, training, and evaluating.</span>

<span class="sd">    !!! tip</span>
<span class="sd">        This is a subclass of `equinox.Module`, so you are free to use pure JAX</span>
<span class="sd">        transformations such as `jax.jit` and `jax.pmap`, as long as you remember to</span>
<span class="sd">        filter out static PyTree fields (e.g. with `eqx.filter_jit`).</span>

<span class="sd">    !!! example</span>
<span class="sd">        Pseudocode for typical `Experiment` usage:</span>
<span class="sd">        ```python</span>

<span class="sd">        exp = MyExperiment(...)  # initialise experiment state</span>

<span class="sd">        for step in range(num_steps):</span>
<span class="sd">            exp, outs = exp.train_step(batch)</span>
<span class="sd">            #do anything with the outputs here</span>

<span class="sd">        # exp is just a pytree, so we can save and restore checkpoints like so...</span>
<span class="sd">        equinox.tree_serialise_leaves(&quot;checkpoint_0.eqx&quot;, exp)</span>


<span class="sd">        ```</span>

<span class="sd">    This class just specifies a recommended interface for experiment code. Experiments</span>
<span class="sd">    implementing this interface will automatically work with the Solstice training</span>
<span class="sd">    loops. You can always create or override methods as you wish and no methods are</span>
<span class="sd">    special-cased. For example it is common to define a `__call__` method to perform</span>
<span class="sd">    inference on a batch of data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialise the experiment.</span>
<span class="sd">        !!! example</span>
<span class="sd">            Pseudocode implementation for initialising an MNIST classifier with flax</span>
<span class="sd">            and optax:</span>
<span class="sd">            ```python</span>
<span class="sd">            class MNISTExperiment(Experiment):</span>
<span class="sd">                params: Any</span>
<span class="sd">                opt_state: Any</span>
<span class="sd">                opt_apply: Callable</span>
<span class="sd">                model_apply: Callable</span>
<span class="sd">                num_classes: int</span>

<span class="sd">                def __init__(self, rng: int, model: flax.nn.Module,</span>
<span class="sd">                    optimizer = optax.GradientTransformation</span>
<span class="sd">                ) -&gt; None:</span>
<span class="sd">                    key = jax.random.PRNGKey(rng)</span>
<span class="sd">                    dummy_batch = jnp.zeros((32, 784))</span>
<span class="sd">                    self.params = model.init(key, dummy_batch)</span>
<span class="sd">                    self.model_apply = model.apply</span>
<span class="sd">                    self.opt = optax.adam(learning_rate=1e-3)</span>
<span class="sd">                    self.opt_state = optimizer.init(self.params)</span>
<span class="sd">                    self.num_classes = 10</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Experiment</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;A training step takes a batch of data and returns the updated experiment and</span>
<span class="sd">        any auxiliary outputs (usually a `solstice.Metrics` object).</span>

<span class="sd">        !!! tip</span>
<span class="sd">            You will typically want to use `jax.jit`, `jax.pmap`, `eqx.filter_jit`, or</span>
<span class="sd">            `eqx.filter_pmap` on this method. See the</span>
<span class="sd">            [solstice primer](https://charl-ai.github.io/Solstice/primer/)</span>
<span class="sd">            for more info on filtered transformations. You can also read the tutorial on</span>
<span class="sd">            different [parallelism strategies](https://charl-ai.github.io/Solstice/parallelism_strategies/).</span>

<span class="sd">        !!! example</span>
<span class="sd">            Pseudocode implementation of a training step:</span>
<span class="sd">            ```python</span>
<span class="sd">            class MNISTExperiment(Experiment):</span>
<span class="sd">                @eqx.filter_jit(kwargs=dict(batch=True))</span>
<span class="sd">                def train_step(self, batch: Tuple[np.ndarray, ...]</span>
<span class="sd">                ) -&gt; Tuple[Experiment, solstice.Metrics]:</span>

<span class="sd">                imgs, labels = batch</span>

<span class="sd">                def loss_fn(params, x, y):</span>
<span class="sd">                    ... # compute loss</span>
<span class="sd">                    return loss, logits</span>

<span class="sd">                (loss, logits), grads = jax.value_and_grad(loss_fn, has_aux=True)(</span>
<span class="sd">                    self.params, imgs, labels</span>
<span class="sd">                )</span>

<span class="sd">                new_params, new_opt_state = ... # calculate grads and update params</span>
<span class="sd">                preds = jnp.argmax(logits, axis=-1)</span>
<span class="sd">                metrics = MyMetrics(preds, labels, loss)</span>

<span class="sd">                return (</span>
<span class="sd">                    solstice.replace(self, params=new_params, opt_state=new_opt_state),</span>
<span class="sd">                    metrics,</span>
<span class="sd">                )</span>
<span class="sd">            ```</span>

<span class="sd">        !!! tip</span>
<span class="sd">            You can use the `solstice.replace` function as a way of returning an</span>
<span class="sd">            experiment instance with modified state.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch (Any): Batch of data. Usually, this will be either a tuple of</span>
<span class="sd">                (input, target) arrays or a dictionary mapping keys to arrays.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Experiment, Any]: A new instance of the Experiment with the updated</span>
<span class="sd">                state and any auxiliary outputs, such as metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">eval_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Experiment</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;An evaluation step (e.g. for validation or testing) takes a batch of data and</span>
<span class="sd">        returns the updated experiment and any auxiliary outputs. Usually, this will be</span>
<span class="sd">        a `solstice.Metrics` object. Like `train_step()`, you should probably JIT this</span>
<span class="sd">        method.</span>

<span class="sd">        !!! tip</span>
<span class="sd">            In most evaluation cases, the experiment returned will be unchanged,</span>
<span class="sd">            the main reason why you would want to modify it is to advance PRNG state.</span>

<span class="sd">        !!! example</span>
<span class="sd">            Pseudocode implementation of an evaluation step:</span>
<span class="sd">            ```python</span>
<span class="sd">            class MNISTExperiment(Experiment):</span>
<span class="sd">                @eqx.filter_jit(kwargs=dict(batch=True))</span>
<span class="sd">                def eval_step(self, batch: Tuple[np.ndarray, ...]</span>
<span class="sd">                ) -&gt; Tuple[Experiment, Any]:</span>
<span class="sd">                imgs, labels = batch</span>

<span class="sd">                logits = ... # apply the model e.g. self.apply_fn(imgs)</span>
<span class="sd">                loss = ... # compute loss</span>
<span class="sd">                preds = jnp.argmax(logits, axis=-1)</span>
<span class="sd">                metrics = MyMetrics(preds, labels, loss)</span>
<span class="sd">                return self, metrics</span>
<span class="sd">            ```</span>

<span class="sd">        Args:</span>
<span class="sd">            batch (Any): Batch of data. Usually, this will be either a tuple of</span>
<span class="sd">                (input, target) arrays or a dictionary mapping keys to arrays.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Experiment, Any]: A new instance of the Experiment with the updated</span>
<span class="sd">                state and any auxiliary outputs, such as metrics.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="solstice.experiment.Experiment.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#solstice.experiment.Experiment.__init__" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents ">
  
      <p>Initialise the experiment.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Pseudocode implementation for initialising an MNIST classifier with flax
and optax:
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MNISTExperiment</span><span class="p">(</span><span class="n">Experiment</span><span class="p">):</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Any</span>
    <span class="n">opt_state</span><span class="p">:</span> <span class="n">Any</span>
    <span class="n">opt_apply</span><span class="p">:</span> <span class="n">Callable</span>
    <span class="n">model_apply</span><span class="p">:</span> <span class="n">Callable</span>
    <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rng</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">flax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">GradientTransformation</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
        <span class="n">dummy_batch</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">784</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dummy_batch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_apply</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">apply</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt_state</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="mi">10</span>
</code></pre></div></p>
</div>

      <details class="quote">
        <summary>Source code in <code>solstice/experiment.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Initialise the experiment.</span>
<span class="sd">    !!! example</span>
<span class="sd">        Pseudocode implementation for initialising an MNIST classifier with flax</span>
<span class="sd">        and optax:</span>
<span class="sd">        ```python</span>
<span class="sd">        class MNISTExperiment(Experiment):</span>
<span class="sd">            params: Any</span>
<span class="sd">            opt_state: Any</span>
<span class="sd">            opt_apply: Callable</span>
<span class="sd">            model_apply: Callable</span>
<span class="sd">            num_classes: int</span>

<span class="sd">            def __init__(self, rng: int, model: flax.nn.Module,</span>
<span class="sd">                optimizer = optax.GradientTransformation</span>
<span class="sd">            ) -&gt; None:</span>
<span class="sd">                key = jax.random.PRNGKey(rng)</span>
<span class="sd">                dummy_batch = jnp.zeros((32, 784))</span>
<span class="sd">                self.params = model.init(key, dummy_batch)</span>
<span class="sd">                self.model_apply = model.apply</span>
<span class="sd">                self.opt = optax.adam(learning_rate=1e-3)</span>
<span class="sd">                self.opt_state = optimizer.init(self.params)</span>
<span class="sd">                self.num_classes = 10</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="solstice.experiment.Experiment.train_step" class="doc doc-heading">
<code class="highlight language-python"><span class="n">train_step</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Experiment</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#solstice.experiment.Experiment.train_step" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents ">
  
      <p>A training step takes a batch of data and returns the updated experiment and
any auxiliary outputs (usually a <code>solstice.Metrics</code> object).</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You will typically want to use <code>jax.jit</code>, <code>jax.pmap</code>, <code>eqx.filter_jit</code>, or
<code>eqx.filter_pmap</code> on this method. See the
<a href="https://charl-ai.github.io/Solstice/primer/">solstice primer</a>
for more info on filtered transformations. You can also read the tutorial on
different <a href="https://charl-ai.github.io/Solstice/parallelism_strategies/">parallelism strategies</a>.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Pseudocode implementation of a training step:
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MNISTExperiment</span><span class="p">(</span><span class="n">Experiment</span><span class="p">):</span>
    <span class="nd">@eqx</span><span class="o">.</span><span class="n">filter_jit</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">batch</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Experiment</span><span class="p">,</span> <span class="n">solstice</span><span class="o">.</span><span class="n">Metrics</span><span class="p">]:</span>

    <span class="n">imgs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span>

    <span class="k">def</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="o">...</span> <span class="c1"># compute loss</span>
        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">logits</span>

    <span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">logits</span><span class="p">),</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">labels</span>
    <span class="p">)</span>

    <span class="n">new_params</span><span class="p">,</span> <span class="n">new_opt_state</span> <span class="o">=</span> <span class="o">...</span> <span class="c1"># calculate grads and update params</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">MyMetrics</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">solstice</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">new_params</span><span class="p">,</span> <span class="n">opt_state</span><span class="o">=</span><span class="n">new_opt_state</span><span class="p">),</span>
        <span class="n">metrics</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can use the <code>solstice.replace</code> function as a way of returning an
experiment instance with modified state.</p>
</div>

  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>batch</b>
            (<code><span title="typing.Any">Any</span></code>)
        – <p>Batch of data. Usually, this will be either a tuple of
(input, target) arrays or a dictionary mapping keys to arrays.</p>
      </li>
  </ul>

  <p>Returns:</p>
  <ul>
      <li class="field-body">
            <code><span title="typing.Tuple">Tuple</span>[<a class="autorefs autorefs-internal" title="solstice.experiment.Experiment" href="#solstice.experiment.Experiment">Experiment</a>, <span title="typing.Any">Any</span>]</code>
        – <p>Tuple[Experiment, Any]: A new instance of the Experiment with the updated
state and any auxiliary outputs, such as metrics.</p>
      </li>
  </ul>

      <details class="quote">
        <summary>Source code in <code>solstice/experiment.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Experiment</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;A training step takes a batch of data and returns the updated experiment and</span>
<span class="sd">    any auxiliary outputs (usually a `solstice.Metrics` object).</span>

<span class="sd">    !!! tip</span>
<span class="sd">        You will typically want to use `jax.jit`, `jax.pmap`, `eqx.filter_jit`, or</span>
<span class="sd">        `eqx.filter_pmap` on this method. See the</span>
<span class="sd">        [solstice primer](https://charl-ai.github.io/Solstice/primer/)</span>
<span class="sd">        for more info on filtered transformations. You can also read the tutorial on</span>
<span class="sd">        different [parallelism strategies](https://charl-ai.github.io/Solstice/parallelism_strategies/).</span>

<span class="sd">    !!! example</span>
<span class="sd">        Pseudocode implementation of a training step:</span>
<span class="sd">        ```python</span>
<span class="sd">        class MNISTExperiment(Experiment):</span>
<span class="sd">            @eqx.filter_jit(kwargs=dict(batch=True))</span>
<span class="sd">            def train_step(self, batch: Tuple[np.ndarray, ...]</span>
<span class="sd">            ) -&gt; Tuple[Experiment, solstice.Metrics]:</span>

<span class="sd">            imgs, labels = batch</span>

<span class="sd">            def loss_fn(params, x, y):</span>
<span class="sd">                ... # compute loss</span>
<span class="sd">                return loss, logits</span>

<span class="sd">            (loss, logits), grads = jax.value_and_grad(loss_fn, has_aux=True)(</span>
<span class="sd">                self.params, imgs, labels</span>
<span class="sd">            )</span>

<span class="sd">            new_params, new_opt_state = ... # calculate grads and update params</span>
<span class="sd">            preds = jnp.argmax(logits, axis=-1)</span>
<span class="sd">            metrics = MyMetrics(preds, labels, loss)</span>

<span class="sd">            return (</span>
<span class="sd">                solstice.replace(self, params=new_params, opt_state=new_opt_state),</span>
<span class="sd">                metrics,</span>
<span class="sd">            )</span>
<span class="sd">        ```</span>

<span class="sd">    !!! tip</span>
<span class="sd">        You can use the `solstice.replace` function as a way of returning an</span>
<span class="sd">        experiment instance with modified state.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch (Any): Batch of data. Usually, this will be either a tuple of</span>
<span class="sd">            (input, target) arrays or a dictionary mapping keys to arrays.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[Experiment, Any]: A new instance of the Experiment with the updated</span>
<span class="sd">            state and any auxiliary outputs, such as metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="solstice.experiment.Experiment.eval_step" class="doc doc-heading">
<code class="highlight language-python"><span class="n">eval_step</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Experiment</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#solstice.experiment.Experiment.eval_step" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents ">
  
      <p>An evaluation step (e.g. for validation or testing) takes a batch of data and
returns the updated experiment and any auxiliary outputs. Usually, this will be
a <code>solstice.Metrics</code> object. Like <code>train_step()</code>, you should probably JIT this
method.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>In most evaluation cases, the experiment returned will be unchanged,
the main reason why you would want to modify it is to advance PRNG state.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Pseudocode implementation of an evaluation step:
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MNISTExperiment</span><span class="p">(</span><span class="n">Experiment</span><span class="p">):</span>
    <span class="nd">@eqx</span><span class="o">.</span><span class="n">filter_jit</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">batch</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">eval_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Experiment</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">imgs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span>

    <span class="n">logits</span> <span class="o">=</span> <span class="o">...</span> <span class="c1"># apply the model e.g. self.apply_fn(imgs)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="o">...</span> <span class="c1"># compute loss</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">MyMetrics</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span>
</code></pre></div></p>
</div>

  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>batch</b>
            (<code><span title="typing.Any">Any</span></code>)
        – <p>Batch of data. Usually, this will be either a tuple of
(input, target) arrays or a dictionary mapping keys to arrays.</p>
      </li>
  </ul>

  <p>Returns:</p>
  <ul>
      <li class="field-body">
            <code><span title="typing.Tuple">Tuple</span>[<a class="autorefs autorefs-internal" title="solstice.experiment.Experiment" href="#solstice.experiment.Experiment">Experiment</a>, <span title="typing.Any">Any</span>]</code>
        – <p>Tuple[Experiment, Any]: A new instance of the Experiment with the updated
state and any auxiliary outputs, such as metrics.</p>
      </li>
  </ul>

      <details class="quote">
        <summary>Source code in <code>solstice/experiment.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">eval_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Experiment</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;An evaluation step (e.g. for validation or testing) takes a batch of data and</span>
<span class="sd">    returns the updated experiment and any auxiliary outputs. Usually, this will be</span>
<span class="sd">    a `solstice.Metrics` object. Like `train_step()`, you should probably JIT this</span>
<span class="sd">    method.</span>

<span class="sd">    !!! tip</span>
<span class="sd">        In most evaluation cases, the experiment returned will be unchanged,</span>
<span class="sd">        the main reason why you would want to modify it is to advance PRNG state.</span>

<span class="sd">    !!! example</span>
<span class="sd">        Pseudocode implementation of an evaluation step:</span>
<span class="sd">        ```python</span>
<span class="sd">        class MNISTExperiment(Experiment):</span>
<span class="sd">            @eqx.filter_jit(kwargs=dict(batch=True))</span>
<span class="sd">            def eval_step(self, batch: Tuple[np.ndarray, ...]</span>
<span class="sd">            ) -&gt; Tuple[Experiment, Any]:</span>
<span class="sd">            imgs, labels = batch</span>

<span class="sd">            logits = ... # apply the model e.g. self.apply_fn(imgs)</span>
<span class="sd">            loss = ... # compute loss</span>
<span class="sd">            preds = jnp.argmax(logits, axis=-1)</span>
<span class="sd">            metrics = MyMetrics(preds, labels, loss)</span>
<span class="sd">            return self, metrics</span>
<span class="sd">        ```</span>

<span class="sd">    Args:</span>
<span class="sd">        batch (Any): Batch of data. Usually, this will be either a tuple of</span>
<span class="sd">            (input, target) arrays or a dictionary mapping keys to arrays.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[Experiment, Any]: A new instance of the Experiment with the updated</span>
<span class="sd">            state and any auxiliary outputs, such as metrics.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div><hr />
<h2 id="metrics">Metrics<a class="headerlink" href="#metrics" title="Permanent link">¤</a></h2>


<div class="doc doc-object doc-module">



  <div class="doc doc-contents first">
  
      <p>Our Metrics API is similar to the one in
<a href="https://github.com/google/CommonLoopUtils">CLU</a>, although more sexy because we use
equinox :) We favour defining one single object for handling all metrics for an
experiment instead of composing multiple objects into a collection. This is more
efficient because often we can calculate a battery of metrics from the same intermediate
results. It is also simpler and easier to reason about.</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="solstice.metrics.Metrics" class="doc doc-heading">
        <code>Metrics</code>


<a href="#solstice.metrics.Metrics" class="headerlink" title="Permanent link">¤</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="equinox">eqx</span>.<span title="equinox.Module">Module</span></code>, <code><span title="abc.ABC">ABC</span></code></p>

  
      <p>Base class for metrics. A Metrics object handles calculating intermediate
metrics from model outputs, accumulating them over batches, then
calculating final metrics from accumulated metrics. Subclass this class and
implement the interface for initialisation, accumulation, and finalisation.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>This class doesn't have to handle 'metrics' in the strictest sense. You could
implement a <code>Metrics</code> class to collect output images for plotting for example.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Pseudocode for typical <code>Metrics</code> usage:</p>
<div class="highlight"><pre><span></span><code><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
    <span class="n">batch_metrics</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>  <span class="c1"># step returns a Metrics object</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">batch_metrics</span><span class="p">)</span> <span class="k">if</span> <span class="n">metrics</span> <span class="k">else</span> <span class="n">batch_metrics</span>

    <span class="k">if</span> <span class="n">time_to_log</span><span class="p">:</span>
        <span class="n">metrics_dict</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="o">...</span> <span class="c1"># log your metrics here</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># reset the object</span>
</code></pre></div>
</div>


        <details class="quote">
          <summary>Source code in <code>solstice/metrics.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Metrics</span><span class="p">(</span><span class="n">eqx</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for metrics. A Metrics object handles calculating intermediate</span>
<span class="sd">    metrics from model outputs, accumulating them over batches, then</span>
<span class="sd">    calculating final metrics from accumulated metrics. Subclass this class and</span>
<span class="sd">    implement the interface for initialisation, accumulation, and finalisation.</span>

<span class="sd">    !!! tip</span>
<span class="sd">        This class doesn&#39;t have to handle &#39;metrics&#39; in the strictest sense. You could</span>
<span class="sd">        implement a `Metrics` class to collect output images for plotting for example.</span>

<span class="sd">    !!! example</span>
<span class="sd">        Pseudocode for typical `Metrics` usage:</span>

<span class="sd">        ```python</span>
<span class="sd">        metrics = None</span>
<span class="sd">        for batch in dataset:</span>
<span class="sd">            batch_metrics = step(batch)  # step returns a Metrics object</span>
<span class="sd">            metrics = metrics.merge(batch_metrics) if metrics else batch_metrics</span>

<span class="sd">            if time_to_log:</span>
<span class="sd">                metrics_dict = metrics.compute()</span>
<span class="sd">                ... # log your metrics here</span>
<span class="sd">                metrics = None  # reset the object</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialise a metrics object, typically with predictions and targets.</span>

<span class="sd">        !!! example</span>
<span class="sd">            Pseudocode for typical `Metrics` initialisation, this example object will</span>
<span class="sd">            keep track of the number of correct predictions and the total number of</span>
<span class="sd">            predictions:</span>
<span class="sd">            ```python</span>
<span class="sd">            class MyMetrics(Metrics):</span>
<span class="sd">                count: int</span>
<span class="sd">                num_correct: int</span>
<span class="sd">                def __init__(self, preds: jnp.ndarray, targets: jnp.ndarray) -&gt; None:</span>
<span class="sd">                    self.count = preds.shape[0]  # assumes batch is first dim</span>
<span class="sd">                    self.num_correct = jnp.sum(preds == targets)</span>
<span class="sd">            ```</span>

<span class="sd">        !!! tip</span>
<span class="sd">            In classification settings, the confusion matrix is a useful intermediate</span>
<span class="sd">            result to calculate during initialisation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Metrics</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Metrics</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Merge two metrics objects, returning a new metrics object.</span>

<span class="sd">        !!! example</span>
<span class="sd">            Pseudocode for typical `Metrics` merging, in the example code, we can simply</span>
<span class="sd">            sum the number of correct predictions and the total number of predictions:</span>
<span class="sd">            ```python</span>
<span class="sd">            class MyMetrics(Metrics):</span>
<span class="sd">                def merge(self, other: Metrics) -&gt; Metrics:</span>
<span class="sd">                    new_num_correct = self.num_correct + other.num_correct</span>
<span class="sd">                    new_count = self.count + other.count</span>
<span class="sd">                    return solstice.replace(self,</span>
<span class="sd">                        num_correct=new_num_correct, count=new_count)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compute final metrics from accumulated metrics.</span>

<span class="sd">        !!! example</span>
<span class="sd">            Pseudocode for typical `Metrics` finalisation, here we calculate accuracy</span>
<span class="sd">            from the number of correct predictions and the total number of predictions:</span>
<span class="sd">            ```python</span>
<span class="sd">            class MyMetrics(Metrics):</span>
<span class="sd">                def compute(self) -&gt; Mapping[str, float]:</span>
<span class="sd">                    return {&#39;accuracy&#39;: self.num_correct / self.count}</span>
<span class="sd">            ```</span>

<span class="sd">        !!! tip</span>
<span class="sd">            Typically, you will want to return a dictionary of metrics. Try to put any</span>
<span class="sd">            expensive computations here, not in `__init__`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="solstice.metrics.Metrics.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#solstice.metrics.Metrics.__init__" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents ">
  
      <p>Initialise a metrics object, typically with predictions and targets.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Pseudocode for typical <code>Metrics</code> initialisation, this example object will
keep track of the number of correct predictions and the total number of
predictions:
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyMetrics</span><span class="p">(</span><span class="n">Metrics</span><span class="p">):</span>
    <span class="n">count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">num_correct</span><span class="p">:</span> <span class="nb">int</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preds</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># assumes batch is first dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_correct</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">preds</span> <span class="o">==</span> <span class="n">targets</span><span class="p">)</span>
</code></pre></div></p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>In classification settings, the confusion matrix is a useful intermediate
result to calculate during initialisation.</p>
</div>

      <details class="quote">
        <summary>Source code in <code>solstice/metrics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Initialise a metrics object, typically with predictions and targets.</span>

<span class="sd">    !!! example</span>
<span class="sd">        Pseudocode for typical `Metrics` initialisation, this example object will</span>
<span class="sd">        keep track of the number of correct predictions and the total number of</span>
<span class="sd">        predictions:</span>
<span class="sd">        ```python</span>
<span class="sd">        class MyMetrics(Metrics):</span>
<span class="sd">            count: int</span>
<span class="sd">            num_correct: int</span>
<span class="sd">            def __init__(self, preds: jnp.ndarray, targets: jnp.ndarray) -&gt; None:</span>
<span class="sd">                self.count = preds.shape[0]  # assumes batch is first dim</span>
<span class="sd">                self.num_correct = jnp.sum(preds == targets)</span>
<span class="sd">        ```</span>

<span class="sd">    !!! tip</span>
<span class="sd">        In classification settings, the confusion matrix is a useful intermediate</span>
<span class="sd">        result to calculate during initialisation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="solstice.metrics.Metrics.merge" class="doc doc-heading">
<code class="highlight language-python"><span class="n">merge</span><span class="p">(</span><span class="n">other</span><span class="p">:</span> <span class="n">Metrics</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Metrics</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#solstice.metrics.Metrics.merge" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents ">
  
      <p>Merge two metrics objects, returning a new metrics object.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Pseudocode for typical <code>Metrics</code> merging, in the example code, we can simply
sum the number of correct predictions and the total number of predictions:
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyMetrics</span><span class="p">(</span><span class="n">Metrics</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Metrics</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Metrics</span><span class="p">:</span>
        <span class="n">new_num_correct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_correct</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">num_correct</span>
        <span class="n">new_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">count</span>
        <span class="k">return</span> <span class="n">solstice</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">num_correct</span><span class="o">=</span><span class="n">new_num_correct</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">new_count</span><span class="p">)</span>
</code></pre></div></p>
</div>

      <details class="quote">
        <summary>Source code in <code>solstice/metrics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Metrics</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Metrics</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Merge two metrics objects, returning a new metrics object.</span>

<span class="sd">    !!! example</span>
<span class="sd">        Pseudocode for typical `Metrics` merging, in the example code, we can simply</span>
<span class="sd">        sum the number of correct predictions and the total number of predictions:</span>
<span class="sd">        ```python</span>
<span class="sd">        class MyMetrics(Metrics):</span>
<span class="sd">            def merge(self, other: Metrics) -&gt; Metrics:</span>
<span class="sd">                new_num_correct = self.num_correct + other.num_correct</span>
<span class="sd">                new_count = self.count + other.count</span>
<span class="sd">                return solstice.replace(self,</span>
<span class="sd">                    num_correct=new_num_correct, count=new_count)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="solstice.metrics.Metrics.compute" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Any</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#solstice.metrics.Metrics.compute" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents ">
  
      <p>Compute final metrics from accumulated metrics.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Pseudocode for typical <code>Metrics</code> finalisation, here we calculate accuracy
from the number of correct predictions and the total number of predictions:
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyMetrics</span><span class="p">(</span><span class="n">Metrics</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_correct</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">}</span>
</code></pre></div></p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Typically, you will want to return a dictionary of metrics. Try to put any
expensive computations here, not in <code>__init__</code>.</p>
</div>

      <details class="quote">
        <summary>Source code in <code>solstice/metrics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compute final metrics from accumulated metrics.</span>

<span class="sd">    !!! example</span>
<span class="sd">        Pseudocode for typical `Metrics` finalisation, here we calculate accuracy</span>
<span class="sd">        from the number of correct predictions and the total number of predictions:</span>
<span class="sd">        ```python</span>
<span class="sd">        class MyMetrics(Metrics):</span>
<span class="sd">            def compute(self) -&gt; Mapping[str, float]:</span>
<span class="sd">                return {&#39;accuracy&#39;: self.num_correct / self.count}</span>
<span class="sd">        ```</span>

<span class="sd">    !!! tip</span>
<span class="sd">        Typically, you will want to return a dictionary of metrics. Try to put any</span>
<span class="sd">        expensive computations here, not in `__init__`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="solstice.metrics.ClassificationMetrics" class="doc doc-heading">
        <code>ClassificationMetrics</code>


<a href="#solstice.metrics.ClassificationMetrics" class="headerlink" title="Permanent link">¤</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="solstice.metrics.Metrics" href="#solstice.metrics.Metrics">Metrics</a></code></p>

  
      <p>Basic metrics for multiclass classification tasks.</p>
<div class="admonition summary">
<p class="admonition-title">Metrics included:<ul>
<li>
<p>Average Loss</p>
</li>
<li>
<p>Accuracy</p>
</li>
<li>
<p>Prevalence</p>
</li>
<li>
<p>F1 score</p>
</li>
<li>
<p>Sensitivity (TPR, recall)</p>
</li>
<li>
<p>Positive predictive value (PPV, precision)</p>
</li>
</ul>
</p>
</div>
<p>Accuracy is reported as Top-1 accuracy which is equal to the micro-average of
precision/recall/f1. Prevalence is reported on a per-class basis. Precision, Recall
and F1 are reported three times: per-class, macro-average, and weighted average (by
prevalence).</p>
<p><em>Not</em> for multi-label classification.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>See <a href="https://en.wikipedia.org/wiki/Confusion_matrix">https://en.wikipedia.org/wiki/Confusion_matrix</a> for more on confusion
matrices and classification metrics.
See <a href="https://scikit-learn.org/stable/modules/model_evaluation.html#from-binary-to-multiclass-and-multilabel">https://scikit-learn.org/stable/modules/model_evaluation.html#from-binary-to-multiclass-and-multilabel</a>
for more on multiclass micro/macro/weighted averaging.</p>
</div>


        <details class="quote">
          <summary>Source code in <code>solstice/metrics.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ClassificationMetrics</span><span class="p">(</span><span class="n">Metrics</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Basic metrics for multiclass classification tasks.</span>
<span class="sd">    !!! summary &quot;Metrics included:&quot;</span>
<span class="sd">            - Average Loss</span>

<span class="sd">            - Accuracy</span>

<span class="sd">            - Prevalence</span>

<span class="sd">            - F1 score</span>

<span class="sd">            - Sensitivity (TPR, recall)</span>

<span class="sd">            - Positive predictive value (PPV, precision)</span>

<span class="sd">    Accuracy is reported as Top-1 accuracy which is equal to the micro-average of</span>
<span class="sd">    precision/recall/f1. Prevalence is reported on a per-class basis. Precision, Recall</span>
<span class="sd">    and F1 are reported three times: per-class, macro-average, and weighted average (by</span>
<span class="sd">    prevalence).</span>

<span class="sd">    *Not* for multi-label classification.</span>

<span class="sd">    !!! info</span>
<span class="sd">        See https://en.wikipedia.org/wiki/Confusion_matrix for more on confusion</span>
<span class="sd">        matrices and classification metrics.</span>
<span class="sd">        See https://scikit-learn.org/stable/modules/model_evaluation.html#from-binary-to-multiclass-and-multilabel</span>
<span class="sd">        for more on multiclass micro/macro/weighted averaging.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_confusion_matrix</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">_average_loss</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">_count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">_num_classes</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">preds</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">loss</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a ClassificationMetrics object from model predictions and targets.</span>

<span class="sd">        Args:</span>
<span class="sd">            preds (jnp.ndarray): Non OH encoded predictions, shape: (batch_size,).</span>
<span class="sd">            targets (jnp.ndarray): Non OH encoded targets, shape: (batch_size,).</span>
<span class="sd">            loss (float): Average loss over the batch (scalar).</span>
<span class="sd">            num_classes (int): Number of classes in classification problem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_confusion_matrix</span> <span class="o">=</span> <span class="n">_compute_confusion_matrix</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_average_loss</span> <span class="o">=</span> <span class="n">loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_classes</span> <span class="o">=</span> <span class="n">num_classes</span>

    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">ClassificationMetrics</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClassificationMetrics</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ClassificationMetrics</span><span class="p">),</span> <span class="p">(</span>
            <span class="s2">&quot;Can only merge ClassificationMetrics object with another&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; ClassificationMetrics object, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_classes</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_num_classes</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Can only merge metrics with same num_classes, got&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_classes</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">_num_classes</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="c1"># can simply sum confusion matrices and count</span>
        <span class="n">new_cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confusion_matrix</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">_confusion_matrix</span>
        <span class="n">new_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">_count</span>

        <span class="c1"># average loss is weighted by count from each object</span>
        <span class="n">new_loss</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_average_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">_average_loss</span> <span class="o">*</span> <span class="n">other</span><span class="o">.</span><span class="n">_count</span>
        <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">_count</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">replace</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">_confusion_matrix</span><span class="o">=</span><span class="n">new_cm</span><span class="p">,</span> <span class="n">_average_loss</span><span class="o">=</span><span class="n">new_loss</span><span class="p">,</span> <span class="n">_count</span><span class="o">=</span><span class="n">new_count</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>

        <span class="n">metrics</span> <span class="o">=</span> <span class="n">_compute_metrics_from_cm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_confusion_matrix</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;average_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_average_loss</span>

        <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="solstice.metrics.ClassificationMetrics.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">preds</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">loss</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

<a href="#solstice.metrics.ClassificationMetrics.__init__" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents ">
  
      <p>Create a ClassificationMetrics object from model predictions and targets.</p>

  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>preds</b>
            (<code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>)
        – <p>Non OH encoded predictions, shape: (batch_size,).</p>
      </li>
      <li class="field-body">
        <b>targets</b>
            (<code><span title="jax.numpy">jnp</span>.<span title="jax.numpy.ndarray">ndarray</span></code>)
        – <p>Non OH encoded targets, shape: (batch_size,).</p>
      </li>
      <li class="field-body">
        <b>loss</b>
            (<code>float</code>)
        – <p>Average loss over the batch (scalar).</p>
      </li>
      <li class="field-body">
        <b>num_classes</b>
            (<code>int</code>)
        – <p>Number of classes in classification problem.</p>
      </li>
  </ul>

      <details class="quote">
        <summary>Source code in <code>solstice/metrics.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">preds</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">loss</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a ClassificationMetrics object from model predictions and targets.</span>

<span class="sd">    Args:</span>
<span class="sd">        preds (jnp.ndarray): Non OH encoded predictions, shape: (batch_size,).</span>
<span class="sd">        targets (jnp.ndarray): Non OH encoded targets, shape: (batch_size,).</span>
<span class="sd">        loss (float): Average loss over the batch (scalar).</span>
<span class="sd">        num_classes (int): Number of classes in classification problem.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_confusion_matrix</span> <span class="o">=</span> <span class="n">_compute_confusion_matrix</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_average_loss</span> <span class="o">=</span> <span class="n">loss</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_classes</span> <span class="o">=</span> <span class="n">num_classes</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div><hr />
<h2 id="training">Training<a class="headerlink" href="#training" title="Permanent link">¤</a></h2>


<div class="doc doc-object doc-module">



  <div class="doc doc-contents first">
  
      <p>Training loops are usually boilerplate code that has little to do with your research.
We provide training and testing loops which integrate with a simple and flexible
callback system. Any <code>solstice.Experiment</code> can be passed to the loops, but you can
always write your own if necessary. We provide a handful of pre-implemented callbacks,
but if they do not suit your needs, you can use them as inspiration to write your own.</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="solstice.trainer.Callback" class="doc doc-heading">
        <code>Callback</code>


<a href="#solstice.trainer.Callback" class="headerlink" title="Permanent link">¤</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="abc.ABC">ABC</span></code></p>

  
      <p>Base class for callbacks to <code>solstice.train()</code> and `solstice.test(). Subclass
and implement this interface to inject arbitrary functionality into the training
and testing loops.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>All callback hooks return <code>None</code>, so they cannot affect the training itself.
Use callbacks to execute side effects like logging, checkpointing or profiling.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Pseudocode callback implementation for logging with <code>solstice.Metrics</code>:
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyLoggingCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_every_n_steps</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_every_n_steps</span> <span class="o">=</span> <span class="n">log_every_n_steps</span>
        <span class="o">...</span> <span class="c1"># set up logging, e.g. wandb.init(...)</span>

    <span class="k">def</span> <span class="nf">on_step_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">global_step</span><span class="p">,</span> <span class="n">training</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">outs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="n">solstice</span><span class="o">.</span><span class="n">Metrics</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">outs</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="k">else</span> <span class="n">outs</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">global_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_every_n_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">metrics_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="o">...</span> <span class="c1"># do logging e.g. wandb.log(metrics_dict)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></p>
</div>


        <details class="quote">
          <summary>Source code in <code>solstice/trainer.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Callback</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for callbacks to `solstice.train()` and `solstice.test(). Subclass</span>
<span class="sd">    and implement this interface to inject arbitrary functionality into the training</span>
<span class="sd">    and testing loops.</span>

<span class="sd">    !!! tip</span>
<span class="sd">        All callback hooks return `None`, so they cannot affect the training itself.</span>
<span class="sd">        Use callbacks to execute side effects like logging, checkpointing or profiling.</span>

<span class="sd">    !!! example</span>
<span class="sd">        Pseudocode callback implementation for logging with `solstice.Metrics`:</span>
<span class="sd">        ```python</span>

<span class="sd">        class MyLoggingCallback(Callback):</span>
<span class="sd">            def __init__(self, log_every_n_steps, ...):</span>
<span class="sd">                self.metrics = None</span>
<span class="sd">                self.log_every_n_steps = log_every_n_steps</span>
<span class="sd">                ... # set up logging, e.g. wandb.init(...)</span>

<span class="sd">            def on_step_end(self, exp, global_step, training, batch, outs):</span>
<span class="sd">                assert isinstance(outs, solstice.Metrics)</span>
<span class="sd">                self.metrics = outs.merge(self.metrics) if self.metrics else outs</span>
<span class="sd">                if (global_step + 1) % self.log_every_n_steps == 0:</span>
<span class="sd">                    metrics_dict = self.metrics.compute()</span>
<span class="sd">                    ... # do logging e.g. wandb.log(metrics_dict)</span>
<span class="sd">                    self.metrics = None</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize the callback.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">on_epoch_start</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Called at the start of each epoch, i.e. before the model has seen any data</span>
<span class="sd">        for that epoch.</span>

<span class="sd">        Args:</span>
<span class="sd">            exp (Experiment): Current Experiment state.</span>
<span class="sd">            epoch (int): Current epoch number.</span>
<span class="sd">            mode (Literal[&quot;train&quot;, &quot;val&quot;, &quot;test&quot;]): String representing whether this is</span>
<span class="sd">                a training, validation or testing epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Called at the end of each epoch, i.e. after the model has seen the full</span>
<span class="sd">        dataset for that epoch.</span>

<span class="sd">        Args:</span>
<span class="sd">            exp (Experiment): Current Experiment state.</span>
<span class="sd">            epoch (int): Current epoch number.</span>
<span class="sd">            mode (Literal[&quot;train&quot;, &quot;val&quot;, &quot;test&quot;]): String representing whether this is</span>
<span class="sd">                a training, validation or testing step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">on_step_start</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span>
        <span class="n">global_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">],</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Called at the start of each training and validation step, i.e. before the</span>
<span class="sd">        batch has been seen.</span>

<span class="sd">        Args:</span>
<span class="sd">            exp (Experiment): Current Experiment state.</span>
<span class="sd">            global_step (int): Current step number. This is the global step, i.e. the</span>
<span class="sd">                total number of training or validation or testing steps seen so far.</span>
<span class="sd">                Note that we keep separate step counts for training and validation, so</span>
<span class="sd">                it might not be unique.</span>
<span class="sd">            mode (Literal[&quot;train&quot;, &quot;val&quot;, &quot;test&quot;]): String representing whether this is</span>
<span class="sd">                a training, validation or testing step.</span>
<span class="sd">            batch (Any): Current batch of data for this step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">on_step_end</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">outs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span>
        <span class="n">global_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">],</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Called at the end of each training and validation step, i.e. after the batch</span>
<span class="sd">        has been seen.</span>

<span class="sd">        Args:</span>
<span class="sd">            exp (Experiment): Current Experiment state.</span>
<span class="sd">            global_step (int): Current step number. This is the global step, i.e. the</span>
<span class="sd">                total number of training or validation or testing steps seen so far.</span>
<span class="sd">                Note that we keep separate step counts for training and validation, so</span>
<span class="sd">                it might not be unique.</span>
<span class="sd">            mode (Literal[&quot;train&quot;, &quot;val&quot;, &quot;test&quot;]): String representing whether this is</span>
<span class="sd">                a training, validation or testing step.</span>
<span class="sd">            batch (Any): Current batch of data for this step.</span>
<span class="sd">            outs (Any): Auxiliary outputs from the experiment train/eval step. Usually,</span>
<span class="sd">                this should be a `solstice.Metrics` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="solstice.trainer.Callback.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#solstice.trainer.Callback.__init__" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents ">
  
      <p>Initialize the callback.</p>

      <details class="quote">
        <summary>Source code in <code>solstice/trainer.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Initialize the callback.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="solstice.trainer.Callback.on_epoch_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">on_epoch_start</span><span class="p">(</span><span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

<a href="#solstice.trainer.Callback.on_epoch_start" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents ">
  
      <p>Called at the start of each epoch, i.e. before the model has seen any data
for that epoch.</p>

  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>exp</b>
            (<code><a class="autorefs autorefs-internal" title="solstice.experiment.Experiment" href="#solstice.experiment.Experiment">Experiment</a></code>)
        – <p>Current Experiment state.</p>
      </li>
      <li class="field-body">
        <b>epoch</b>
            (<code>int</code>)
        – <p>Current epoch number.</p>
      </li>
      <li class="field-body">
        <b>mode</b>
            (<code><span title="typing_extensions.Literal">Literal</span>[<a class="autorefs autorefs-internal" title="solstice.trainer.train" href="#solstice.trainer.train">train</a>, val, <a class="autorefs autorefs-internal" title="solstice.trainer.test" href="#solstice.trainer.test">test</a>]</code>)
        – <p>String representing whether this is
a training, validation or testing epoch.</p>
      </li>
  </ul>

      <details class="quote">
        <summary>Source code in <code>solstice/trainer.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">on_epoch_start</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Called at the start of each epoch, i.e. before the model has seen any data</span>
<span class="sd">    for that epoch.</span>

<span class="sd">    Args:</span>
<span class="sd">        exp (Experiment): Current Experiment state.</span>
<span class="sd">        epoch (int): Current epoch number.</span>
<span class="sd">        mode (Literal[&quot;train&quot;, &quot;val&quot;, &quot;test&quot;]): String representing whether this is</span>
<span class="sd">            a training, validation or testing epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="solstice.trainer.Callback.on_epoch_end" class="doc doc-heading">
<code class="highlight language-python"><span class="n">on_epoch_end</span><span class="p">(</span><span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">test</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

<a href="#solstice.trainer.Callback.on_epoch_end" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents ">
  
      <p>Called at the end of each epoch, i.e. after the model has seen the full
dataset for that epoch.</p>

  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>exp</b>
            (<code><a class="autorefs autorefs-internal" title="solstice.experiment.Experiment" href="#solstice.experiment.Experiment">Experiment</a></code>)
        – <p>Current Experiment state.</p>
      </li>
      <li class="field-body">
        <b>epoch</b>
            (<code>int</code>)
        – <p>Current epoch number.</p>
      </li>
      <li class="field-body">
        <b>mode</b>
            (<code><span title="typing_extensions.Literal">Literal</span>[<a class="autorefs autorefs-internal" title="solstice.trainer.train" href="#solstice.trainer.train">train</a>, val, <a class="autorefs autorefs-internal" title="solstice.trainer.test" href="#solstice.trainer.test">test</a>]</code>)
        – <p>String representing whether this is
a training, validation or testing step.</p>
      </li>
  </ul>

      <details class="quote">
        <summary>Source code in <code>solstice/trainer.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Called at the end of each epoch, i.e. after the model has seen the full</span>
<span class="sd">    dataset for that epoch.</span>

<span class="sd">    Args:</span>
<span class="sd">        exp (Experiment): Current Experiment state.</span>
<span class="sd">        epoch (int): Current epoch number.</span>
<span class="sd">        mode (Literal[&quot;train&quot;, &quot;val&quot;, &quot;test&quot;]): String representing whether this is</span>
<span class="sd">            a training, validation or testing step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="solstice.trainer.Callback.on_step_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">on_step_start</span><span class="p">(</span><span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span> <span class="n">global_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">test</span><span class="p">],</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

<a href="#solstice.trainer.Callback.on_step_start" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents ">
  
      <p>Called at the start of each training and validation step, i.e. before the
batch has been seen.</p>

  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>exp</b>
            (<code><a class="autorefs autorefs-internal" title="solstice.experiment.Experiment" href="#solstice.experiment.Experiment">Experiment</a></code>)
        – <p>Current Experiment state.</p>
      </li>
      <li class="field-body">
        <b>global_step</b>
            (<code>int</code>)
        – <p>Current step number. This is the global step, i.e. the
total number of training or validation or testing steps seen so far.
Note that we keep separate step counts for training and validation, so
it might not be unique.</p>
      </li>
      <li class="field-body">
        <b>mode</b>
            (<code><span title="typing_extensions.Literal">Literal</span>[<a class="autorefs autorefs-internal" title="solstice.trainer.train" href="#solstice.trainer.train">train</a>, val, <a class="autorefs autorefs-internal" title="solstice.trainer.test" href="#solstice.trainer.test">test</a>]</code>)
        – <p>String representing whether this is
a training, validation or testing step.</p>
      </li>
      <li class="field-body">
        <b>batch</b>
            (<code><span title="typing.Any">Any</span></code>)
        – <p>Current batch of data for this step.</p>
      </li>
  </ul>

      <details class="quote">
        <summary>Source code in <code>solstice/trainer.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">on_step_start</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span>
    <span class="n">global_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">],</span>
    <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Called at the start of each training and validation step, i.e. before the</span>
<span class="sd">    batch has been seen.</span>

<span class="sd">    Args:</span>
<span class="sd">        exp (Experiment): Current Experiment state.</span>
<span class="sd">        global_step (int): Current step number. This is the global step, i.e. the</span>
<span class="sd">            total number of training or validation or testing steps seen so far.</span>
<span class="sd">            Note that we keep separate step counts for training and validation, so</span>
<span class="sd">            it might not be unique.</span>
<span class="sd">        mode (Literal[&quot;train&quot;, &quot;val&quot;, &quot;test&quot;]): String representing whether this is</span>
<span class="sd">            a training, validation or testing step.</span>
<span class="sd">        batch (Any): Current batch of data for this step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="solstice.trainer.Callback.on_step_end" class="doc doc-heading">
<code class="highlight language-python"><span class="n">on_step_end</span><span class="p">(</span><span class="n">outs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span> <span class="n">global_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">test</span><span class="p">],</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

<a href="#solstice.trainer.Callback.on_step_end" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents ">
  
      <p>Called at the end of each training and validation step, i.e. after the batch
has been seen.</p>

  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>exp</b>
            (<code><a class="autorefs autorefs-internal" title="solstice.experiment.Experiment" href="#solstice.experiment.Experiment">Experiment</a></code>)
        – <p>Current Experiment state.</p>
      </li>
      <li class="field-body">
        <b>global_step</b>
            (<code>int</code>)
        – <p>Current step number. This is the global step, i.e. the
total number of training or validation or testing steps seen so far.
Note that we keep separate step counts for training and validation, so
it might not be unique.</p>
      </li>
      <li class="field-body">
        <b>mode</b>
            (<code><span title="typing_extensions.Literal">Literal</span>[<a class="autorefs autorefs-internal" title="solstice.trainer.train" href="#solstice.trainer.train">train</a>, val, <a class="autorefs autorefs-internal" title="solstice.trainer.test" href="#solstice.trainer.test">test</a>]</code>)
        – <p>String representing whether this is
a training, validation or testing step.</p>
      </li>
      <li class="field-body">
        <b>batch</b>
            (<code><span title="typing.Any">Any</span></code>)
        – <p>Current batch of data for this step.</p>
      </li>
      <li class="field-body">
        <b>outs</b>
            (<code><span title="typing.Any">Any</span></code>)
        – <p>Auxiliary outputs from the experiment train/eval step. Usually,
this should be a <code>solstice.Metrics</code> object.</p>
      </li>
  </ul>

      <details class="quote">
        <summary>Source code in <code>solstice/trainer.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">on_step_end</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">outs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span>
    <span class="n">global_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">],</span>
    <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Called at the end of each training and validation step, i.e. after the batch</span>
<span class="sd">    has been seen.</span>

<span class="sd">    Args:</span>
<span class="sd">        exp (Experiment): Current Experiment state.</span>
<span class="sd">        global_step (int): Current step number. This is the global step, i.e. the</span>
<span class="sd">            total number of training or validation or testing steps seen so far.</span>
<span class="sd">            Note that we keep separate step counts for training and validation, so</span>
<span class="sd">            it might not be unique.</span>
<span class="sd">        mode (Literal[&quot;train&quot;, &quot;val&quot;, &quot;test&quot;]): String representing whether this is</span>
<span class="sd">            a training, validation or testing step.</span>
<span class="sd">        batch (Any): Current batch of data for this step.</span>
<span class="sd">        outs (Any): Auxiliary outputs from the experiment train/eval step. Usually,</span>
<span class="sd">            this should be a `solstice.Metrics` object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="solstice.trainer.LoggingCallback" class="doc doc-heading">
        <code>LoggingCallback</code>


<a href="#solstice.trainer.LoggingCallback" class="headerlink" title="Permanent link">¤</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="solstice.trainer.Callback" href="#solstice.trainer.Callback">Callback</a></code></p>

  
      <p>Logs auxiliary outputs from training or evaulation steps (either periodically
every n steps, or at the end of the epoch). Internally, this accumulates metrics
with <code>metrics.merge()</code>, computes them with <code>metrics.compute()</code>, and then passes
the final results to the given logging function.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Auxiliary outputs from the train and eval steps must be a <code>solstice.Metrics</code>
instance for this callback to work properly. We raise an AssertionError if this
is not the case.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are many different libraries you can use for writing logs (e.g. wandb,
TensorBoard(X), ...). We offer no opinion on which one you should use. Pass in
a logging function to use any arbitrary logger.</p>
</div>


        <details class="quote">
          <summary>Source code in <code>solstice/trainer.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">LoggingCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Logs auxiliary outputs from training or evaulation steps (either periodically</span>
<span class="sd">    every n steps, or at the end of the epoch). Internally, this accumulates metrics</span>
<span class="sd">    with `metrics.merge()`, computes them with `metrics.compute()`, and then passes</span>
<span class="sd">    the final results to the given logging function.</span>

<span class="sd">    !!! warning</span>
<span class="sd">        Auxiliary outputs from the train and eval steps must be a `solstice.Metrics`</span>
<span class="sd">        instance for this callback to work properly. We raise an AssertionError if this</span>
<span class="sd">        is not the case.</span>

<span class="sd">    !!! note</span>
<span class="sd">        There are many different libraries you can use for writing logs (e.g. wandb,</span>
<span class="sd">        TensorBoard(X), ...). We offer no opinion on which one you should use. Pass in</span>
<span class="sd">        a logging function to use any arbitrary logger.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">log_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">logging_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize the logging callback.</span>

<span class="sd">        Args:</span>
<span class="sd">            log_every_n_steps (int | None, optional): If given, accumulate metrics over</span>
<span class="sd">                n steps before logging. If None, log at end of epoch. Defaults to None.</span>
<span class="sd">            logging_fn (Callable[[Any, int, Literal[&#39;train&#39;, &#39;val&#39;, &#39;test&#39;]], None] | None, optional):</span>
<span class="sd">                Logging function. Takes the outputs of `metrics.compute()`, the current</span>
<span class="sd">                step or epoch number, and a string representing whether training,</span>
<span class="sd">                validating, or testing. The function should return nothing. If no</span>
<span class="sd">                logging_fn is given, the default behaviour is to log with the built in</span>
<span class="sd">                Python logger (INFO level). Defaults to None.</span>

<span class="sd">        !!! example</span>
<span class="sd">            The default logging function (used if None is given) logs using the built</span>
<span class="sd">            in Python logger, with name &quot;solstice&quot; and INFO level</span>
<span class="sd">            (notice that the output of `metrics.compute()` must be printable):</span>
<span class="sd">            ```python</span>
<span class="sd">            logger = logging.getLogger(&quot;solstice&quot;)</span>

<span class="sd">            default_logger = lambda metrics, step, mode: logging.info(</span>
<span class="sd">                f&quot;{mode} step {step}: {metrics}&quot;</span>
<span class="sd">            )</span>
<span class="sd">            ```</span>

<span class="sd">            If the logs aren&#39;t showing, you might need to put this line at the top of</span>
<span class="sd">            your script:</span>
<span class="sd">            ```python</span>
<span class="sd">            import logging</span>
<span class="sd">            logging.getLogger(&quot;solstice&quot;).setLevel(logging.INFO)</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">default_logger</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metrics</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging_fn</span> <span class="o">=</span> <span class="n">logging_fn</span> <span class="k">if</span> <span class="n">logging_fn</span> <span class="k">else</span> <span class="n">default_logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_every_n_steps</span> <span class="o">=</span> <span class="n">log_every_n_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">on_step_end</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">outs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span>
        <span class="n">global_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">],</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">exp</span><span class="p">,</span> <span class="n">batch</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="n">Metrics</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">outs</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="k">else</span> <span class="n">outs</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_every_n_steps</span> <span class="ow">and</span> <span class="p">(</span><span class="n">global_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_every_n_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">final_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logging_fn</span><span class="p">(</span><span class="n">final_metrics</span><span class="p">,</span> <span class="n">global_step</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">exp</span>
        <span class="c1"># if not logging every n steps, we just log at the end of the epoch</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_every_n_steps</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">final_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logging_fn</span><span class="p">(</span><span class="n">final_metrics</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="c1"># reset the metrics object to prevent train/val metrics from being mixed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="solstice.trainer.LoggingCallback.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">log_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">logging_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">test</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

<a href="#solstice.trainer.LoggingCallback.__init__" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents ">
  
      <p>Initialize the logging callback.</p>

  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>log_every_n_steps</b>
            (<code>int | None</code>)
        – <p>If given, accumulate metrics over
n steps before logging. If None, log at end of epoch. Defaults to None.</p>
      </li>
      <li class="field-body">
        <b>logging_fn</b>
            (<code><span title="typing.Callable">Callable</span>[[<span title="typing.Any">Any</span>, int, <span title="typing_extensions.Literal">Literal</span>[<a class="autorefs autorefs-internal" title="solstice.trainer.train" href="#solstice.trainer.train">train</a>, val, <a class="autorefs autorefs-internal" title="solstice.trainer.test" href="#solstice.trainer.test">test</a>]], None] | None</code>)
        – <p>Logging function. Takes the outputs of <code>metrics.compute()</code>, the current
step or epoch number, and a string representing whether training,
validating, or testing. The function should return nothing. If no
logging_fn is given, the default behaviour is to log with the built in
Python logger (INFO level). Defaults to None.</p>
      </li>
  </ul>
      <div class="admonition example">
<p class="admonition-title">Example</p>
<p>The default logging function (used if None is given) logs using the built
in Python logger, with name "solstice" and INFO level
(notice that the output of <code>metrics.compute()</code> must be printable):
<div class="highlight"><pre><span></span><code><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;solstice&quot;</span><span class="p">)</span>

<span class="n">default_logger</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metrics</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="p">)</span>
</code></pre></div></p>
<p>If the logs aren't showing, you might need to put this line at the top of
your script:
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;solstice&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</code></pre></div></p>
</div>

      <details class="quote">
        <summary>Source code in <code>solstice/trainer.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">log_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">logging_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]</span>
    <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Initialize the logging callback.</span>

<span class="sd">    Args:</span>
<span class="sd">        log_every_n_steps (int | None, optional): If given, accumulate metrics over</span>
<span class="sd">            n steps before logging. If None, log at end of epoch. Defaults to None.</span>
<span class="sd">        logging_fn (Callable[[Any, int, Literal[&#39;train&#39;, &#39;val&#39;, &#39;test&#39;]], None] | None, optional):</span>
<span class="sd">            Logging function. Takes the outputs of `metrics.compute()`, the current</span>
<span class="sd">            step or epoch number, and a string representing whether training,</span>
<span class="sd">            validating, or testing. The function should return nothing. If no</span>
<span class="sd">            logging_fn is given, the default behaviour is to log with the built in</span>
<span class="sd">            Python logger (INFO level). Defaults to None.</span>

<span class="sd">    !!! example</span>
<span class="sd">        The default logging function (used if None is given) logs using the built</span>
<span class="sd">        in Python logger, with name &quot;solstice&quot; and INFO level</span>
<span class="sd">        (notice that the output of `metrics.compute()` must be printable):</span>
<span class="sd">        ```python</span>
<span class="sd">        logger = logging.getLogger(&quot;solstice&quot;)</span>

<span class="sd">        default_logger = lambda metrics, step, mode: logging.info(</span>
<span class="sd">            f&quot;{mode} step {step}: {metrics}&quot;</span>
<span class="sd">        )</span>
<span class="sd">        ```</span>

<span class="sd">        If the logs aren&#39;t showing, you might need to put this line at the top of</span>
<span class="sd">        your script:</span>
<span class="sd">        ```python</span>
<span class="sd">        import logging</span>
<span class="sd">        logging.getLogger(&quot;solstice&quot;).setLevel(logging.INFO)</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_logger</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metrics</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logging_fn</span> <span class="o">=</span> <span class="n">logging_fn</span> <span class="k">if</span> <span class="n">logging_fn</span> <span class="k">else</span> <span class="n">default_logger</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_every_n_steps</span> <span class="o">=</span> <span class="n">log_every_n_steps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="solstice.trainer.CheckpointingCallback" class="doc doc-heading">
        <code>CheckpointingCallback</code>


<a href="#solstice.trainer.CheckpointingCallback" class="headerlink" title="Permanent link">¤</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="solstice.trainer.Callback" href="#solstice.trainer.Callback">Callback</a></code></p>

  
      <p>Checkpoint the experiment state at the end of each epoch.</p>
<div class="admonition todo">
<p class="admonition-title">Todo</p>
<p>Implement this. Consider adding asynchronous checkpointing.</p>
</div>


        <details class="quote">
          <summary>Source code in <code>solstice/trainer.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CheckpointingCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checkpoint the experiment state at the end of each epoch.</span>

<span class="sd">    !!! todo</span>
<span class="sd">        Implement this. Consider adding asynchronous checkpointing.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
        </details>

  </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="solstice.trainer.ProfilingCallback" class="doc doc-heading">
        <code>ProfilingCallback</code>


<a href="#solstice.trainer.ProfilingCallback" class="headerlink" title="Permanent link">¤</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="solstice.trainer.Callback" href="#solstice.trainer.Callback">Callback</a></code></p>

  
      <p>Uses the built-in JAX (TensorBoard) profiler to profile training and evaluation
steps.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To view the traces, ensure TensorBoard is installed. Then run
<code>tensorboard --logdir=&lt;log_dir&gt;</code>. See
<a href="https://jax.readthedocs.io/en/latest/profiling.html">https://jax.readthedocs.io/en/latest/profiling.html</a> for more information.</p>
</div>


        <details class="quote">
          <summary>Source code in <code>solstice/trainer.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ProfilingCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Uses the built-in JAX (TensorBoard) profiler to profile training and evaluation</span>
<span class="sd">    steps.</span>

<span class="sd">    !!! note</span>
<span class="sd">        To view the traces, ensure TensorBoard is installed. Then run</span>
<span class="sd">        `tensorboard --logdir=&lt;log_dir&gt;`. See</span>
<span class="sd">        https://jax.readthedocs.io/en/latest/profiling.html for more information.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">steps_to_profile</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Profiler callback.</span>

<span class="sd">        !!! tip</span>
<span class="sd">            You can use the `steps_to_profile` argument to profile only a subset of the</span>
<span class="sd">            steps. Usually, step 0 will be slowest due to JIT compilation, so you might</span>
<span class="sd">            want to profile steps 0 and 1.</span>

<span class="sd">        Args:</span>
<span class="sd">            log_dir (str): Directory to write the profiler trace files to.</span>
<span class="sd">            steps_to_profile (list[int] | None, optional): If given, only profile these</span>
<span class="sd">                steps, else profile every step. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span> <span class="o">=</span> <span class="n">log_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_to_profile</span> <span class="o">=</span> <span class="n">steps_to_profile</span>

    <span class="k">def</span> <span class="nf">on_step_start</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span>
        <span class="n">global_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">],</span>
        <span class="n">batch</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">exp</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">batch</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_to_profile</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">global_step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_to_profile</span><span class="p">:</span>
            <span class="n">jax</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">start_trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_step_end</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">outs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span>
        <span class="n">global_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">],</span>
        <span class="n">batch</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">exp</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">outs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_to_profile</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">global_step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_to_profile</span><span class="p">:</span>
            <span class="n">jax</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">stop_trace</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="solstice.trainer.ProfilingCallback.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">log_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">steps_to_profile</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

<a href="#solstice.trainer.ProfilingCallback.__init__" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents ">
  
      <p>Initialize the Profiler callback.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can use the <code>steps_to_profile</code> argument to profile only a subset of the
steps. Usually, step 0 will be slowest due to JIT compilation, so you might
want to profile steps 0 and 1.</p>
</div>

  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>log_dir</b>
            (<code>str</code>)
        – <p>Directory to write the profiler trace files to.</p>
      </li>
      <li class="field-body">
        <b>steps_to_profile</b>
            (<code>list[int] | None</code>)
        – <p>If given, only profile these
steps, else profile every step. Defaults to None.</p>
      </li>
  </ul>

      <details class="quote">
        <summary>Source code in <code>solstice/trainer.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">steps_to_profile</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Initialize the Profiler callback.</span>

<span class="sd">    !!! tip</span>
<span class="sd">        You can use the `steps_to_profile` argument to profile only a subset of the</span>
<span class="sd">        steps. Usually, step 0 will be slowest due to JIT compilation, so you might</span>
<span class="sd">        want to profile steps 0 and 1.</span>

<span class="sd">    Args:</span>
<span class="sd">        log_dir (str): Directory to write the profiler trace files to.</span>
<span class="sd">        steps_to_profile (list[int] | None, optional): If given, only profile these</span>
<span class="sd">            steps, else profile every step. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span> <span class="o">=</span> <span class="n">log_dir</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">steps_to_profile</span> <span class="o">=</span> <span class="n">steps_to_profile</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="solstice.trainer.EarlyStoppingCallback" class="doc doc-heading">
        <code>EarlyStoppingCallback</code>


<a href="#solstice.trainer.EarlyStoppingCallback" class="headerlink" title="Permanent link">¤</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="solstice.trainer.Callback" href="#solstice.trainer.Callback">Callback</a></code></p>

  
      <p>Stops training early if a criterion is met. Checks once per validation epoch
(at the end). This callback accumulates auxiliary outputs from each validation step
into a list and passes them to the criterion function which determines whether to
stop training.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If this callback doesn't suit your needs, you can implement your own early
stopping callback by raising an <code>EarlyStoppingException</code> in the <code>on_step_end</code>
hook.</p>
</div>


        <details class="quote">
          <summary>Source code in <code>solstice/trainer.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">EarlyStoppingCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stops training early if a criterion is met. Checks once per validation epoch</span>
<span class="sd">    (at the end). This callback accumulates auxiliary outputs from each validation step</span>
<span class="sd">    into a list and passes them to the criterion function which determines whether to</span>
<span class="sd">    stop training.</span>

<span class="sd">    !!! tip</span>
<span class="sd">        If this callback doesn&#39;t suit your needs, you can implement your own early</span>
<span class="sd">        stopping callback by raising an `EarlyStoppingException` in the `on_step_end`</span>
<span class="sd">        hook.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">criterion_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">accumulate_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize the EarlyStoppingCallback.</span>

<span class="sd">        Args:</span>
<span class="sd">            criterion_fn (Callable[[list[Any]], bool]): Function that takes a list of</span>
<span class="sd">                the accumulated auxiliary outputs from each step and returns a boolean</span>
<span class="sd">                indicating whether to stop training.</span>
<span class="sd">            accumulate_every_n_steps (int, optional): Accumulate auxiliary outputs every</span>
<span class="sd">                nth step. Set to 2 to only keep half, 3 for keeping 1/3, etc. This</span>
<span class="sd">                effectively downsamples the signal (so beware it is losing information).</span>
<span class="sd">                Defaults to 1.</span>

<span class="sd">        !!! example</span>
<span class="sd">            Example criterion function takes the final metrics object, calls .compute()</span>
<span class="sd">            on it to return a dictionary, and stops training if accuracy is &gt; 0.9:</span>
<span class="sd">            TODO: update example when `solstice.reduce`  is implemented</span>
<span class="sd">            ```python</span>
<span class="sd">            criterion fn = lambda metrics: metrics.compute()[&quot;accuracy&quot;] &gt; 0.9</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accumulated_outs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criterion_fn</span> <span class="o">=</span> <span class="n">criterion_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accumulate_every_n_steps</span> <span class="o">=</span> <span class="n">accumulate_every_n_steps</span>

    <span class="k">def</span> <span class="nf">on_step_end</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">outs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span>
        <span class="n">global_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">],</span>
        <span class="n">batch</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">exp</span><span class="p">,</span> <span class="n">batch</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;val&quot;</span> <span class="ow">and</span> <span class="n">global_step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">accumulate_every_n_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">accumulated_outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">exp</span><span class="p">,</span> <span class="n">epoch</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accumulated_outs</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">EarlyStoppingException</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accumulated_outs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># reset for next epoch</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="solstice.trainer.EarlyStoppingCallback.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">criterion_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">],</span> <span class="n">accumulate_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

<a href="#solstice.trainer.EarlyStoppingCallback.__init__" class="headerlink" title="Permanent link">¤</a></h4>


  <div class="doc doc-contents ">
  
      <p>Initialize the EarlyStoppingCallback.</p>

  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>criterion_fn</b>
            (<code><span title="typing.Callable">Callable</span>[[list[<span title="typing.Any">Any</span>]], bool]</code>)
        – <p>Function that takes a list of
the accumulated auxiliary outputs from each step and returns a boolean
indicating whether to stop training.</p>
      </li>
      <li class="field-body">
        <b>accumulate_every_n_steps</b>
            (<code>int</code>)
        – <p>Accumulate auxiliary outputs every
nth step. Set to 2 to only keep half, 3 for keeping 1/3, etc. This
effectively downsamples the signal (so beware it is losing information).
Defaults to 1.</p>
      </li>
  </ul>
      <div class="admonition example">
<p class="admonition-title">Example</p>
<p>Example criterion function takes the final metrics object, calls .compute()
on it to return a dictionary, and stops training if accuracy is &gt; 0.9:
TODO: update example when <code>solstice.reduce</code>  is implemented
<div class="highlight"><pre><span></span><code><span class="n">criterion</span> <span class="n">fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">metrics</span><span class="o">.</span><span class="n">compute</span><span class="p">()[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.9</span>
</code></pre></div></p>
</div>

      <details class="quote">
        <summary>Source code in <code>solstice/trainer.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">criterion_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">],</span>
    <span class="n">accumulate_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Initialize the EarlyStoppingCallback.</span>

<span class="sd">    Args:</span>
<span class="sd">        criterion_fn (Callable[[list[Any]], bool]): Function that takes a list of</span>
<span class="sd">            the accumulated auxiliary outputs from each step and returns a boolean</span>
<span class="sd">            indicating whether to stop training.</span>
<span class="sd">        accumulate_every_n_steps (int, optional): Accumulate auxiliary outputs every</span>
<span class="sd">            nth step. Set to 2 to only keep half, 3 for keeping 1/3, etc. This</span>
<span class="sd">            effectively downsamples the signal (so beware it is losing information).</span>
<span class="sd">            Defaults to 1.</span>

<span class="sd">    !!! example</span>
<span class="sd">        Example criterion function takes the final metrics object, calls .compute()</span>
<span class="sd">        on it to return a dictionary, and stops training if accuracy is &gt; 0.9:</span>
<span class="sd">        TODO: update example when `solstice.reduce`  is implemented</span>
<span class="sd">        ```python</span>
<span class="sd">        criterion fn = lambda metrics: metrics.compute()[&quot;accuracy&quot;] &gt; 0.9</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">accumulated_outs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">criterion_fn</span> <span class="o">=</span> <span class="n">criterion_fn</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">accumulate_every_n_steps</span> <span class="o">=</span> <span class="n">accumulate_every_n_steps</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="solstice.trainer.train" class="doc doc-heading">
<code class="highlight language-python"><span class="n">train</span><span class="p">(</span><span class="n">exp</span><span class="p">:</span> <span class="n">ExperimentType</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">val_ds</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">callbacks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callback</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExperimentType</span></code>

<a href="#solstice.trainer.train" class="headerlink" title="Permanent link">¤</a></h3>


  <div class="doc doc-contents ">
  
      <p>Train a <code>solstice.Experiment</code>, using <code>tf.data.Dataset</code> for data loading.
Supply <code>solstice.Callback</code>s to add any additional functionality.</p>

  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>exp</b>
            (<code><a class="autorefs autorefs-internal" title="solstice.experiment.Experiment" href="#solstice.experiment.Experiment">Experiment</a></code>)
        – <p>Solstice experiment to train.</p>
      </li>
      <li class="field-body">
        <b>num_epochs</b>
            (<code>int</code>)
        – <p>Number of epochs to train for.</p>
      </li>
      <li class="field-body">
        <b>train_ds</b>
            (<code><span title="tensorflow">tf</span>.<span title="tensorflow.data">data</span>.<span title="tf.data.Dataset">Dataset</span></code>)
        – <p>TensorFlow dataset of training data.</p>
      </li>
      <li class="field-body">
        <b>val_ds</b>
            (<code><span title="tensorflow">tf</span>.<span title="tensorflow.data">data</span>.<span title="tf.data.Dataset">Dataset</span> | None</code>)
        – <p>TensorFlow dataset of validation
data. If none is given, validation is skipped. Defaults to None.</p>
      </li>
      <li class="field-body">
        <b>callbacks</b>
            (<code>list[<a class="autorefs autorefs-internal" title="solstice.trainer.Callback" href="#solstice.trainer.Callback">Callback</a>] | None</code>)
        – <p>List of Solstice callbacks. These
can execute arbitrary code on certain events, usually for side effects like
logging and checkpointing. See <code>solstice.Callback</code>. Defaults to None.</p>
      </li>
  </ul>

  <p>Returns:</p>
  <ul>
      <li class="field-body">
<b>Experiment</b>(            <code><span title="solstice.trainer.ExperimentType">ExperimentType</span></code>
)        – <p>Trained experiment.</p>
      </li>
  </ul>

      <details class="quote">
        <summary>Source code in <code>solstice/trainer.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
    <span class="n">exp</span><span class="p">:</span> <span class="n">ExperimentType</span><span class="p">,</span>
    <span class="n">num_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">train_ds</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">val_ds</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callback</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExperimentType</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Train a `solstice.Experiment`, using `tf.data.Dataset` for data loading.</span>
<span class="sd">    Supply `solstice.Callback`s to add any additional functionality.</span>

<span class="sd">    Args:</span>
<span class="sd">        exp (Experiment): Solstice experiment to train.</span>
<span class="sd">        num_epochs (int): Number of epochs to train for.</span>
<span class="sd">        train_ds (tf.data.Dataset): TensorFlow dataset of training data.</span>
<span class="sd">        val_ds (tf.data.Dataset | None, optional): TensorFlow dataset of validation</span>
<span class="sd">            data. If none is given, validation is skipped. Defaults to None.</span>
<span class="sd">        callbacks (list[Callback] | None, optional): List of Solstice callbacks. These</span>
<span class="sd">            can execute arbitrary code on certain events, usually for side effects like</span>
<span class="sd">            logging and checkpointing. See `solstice.Callback`. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Experiment: Trained experiment.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Training&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>  <span class="c1"># just for mypy for type narrowing</span>

        <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">val_ds</span><span class="p">]):</span>
            <span class="k">assert</span> <span class="n">_is_valid_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>  <span class="c1"># type narrowing</span>
            <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="p">[</span>
                <span class="n">cb</span><span class="o">.</span><span class="n">on_epoch_start</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">callbacks</span>
            <span class="p">]</span> <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">global_step</span> <span class="o">=</span> <span class="n">epoch</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>  <span class="c1"># nb: separate step counts for train and val</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">as_numpy_iterator</span><span class="p">(),</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">),</span>
                <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="p">[</span>
                    <span class="n">cb</span><span class="o">.</span><span class="n">on_step_start</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">global_step</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span> <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">callbacks</span>
                <span class="p">]</span> <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

                <span class="n">exp</span><span class="p">,</span> <span class="n">outs</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">exp</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span> <span class="k">else</span> <span class="n">exp</span><span class="o">.</span><span class="n">eval_step</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="p">[</span>
                    <span class="n">cb</span><span class="o">.</span><span class="n">on_step_end</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">global_step</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">callbacks</span>
                <span class="p">]</span> <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="p">[</span>
                    <span class="n">cb</span><span class="o">.</span><span class="n">on_epoch_end</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">callbacks</span>
                <span class="p">]</span> <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="n">EarlyStoppingException</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Early stopping at epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">exp</span>
    <span class="k">return</span> <span class="n">exp</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="solstice.trainer.test" class="doc doc-heading">
<code class="highlight language-python"><span class="n">test</span><span class="p">(</span><span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span> <span class="n">test_ds</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">callbacks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callback</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_outs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span></code>

<a href="#solstice.trainer.test" class="headerlink" title="Permanent link">¤</a></h3>


  <div class="doc doc-contents ">
  
      <p>Test a <code>solstice.Experiment</code>, using <code>tf.data.Dataset</code> for data loading. Supply
<code>solstice.Callback</code>s to add any additional functionality.</p>

  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>exp</b>
            (<code><a class="autorefs autorefs-internal" title="solstice.experiment.Experiment" href="#solstice.experiment.Experiment">Experiment</a></code>)
        – <p>Experiment to test.</p>
      </li>
      <li class="field-body">
        <b>test_ds</b>
            (<code><span title="tensorflow">tf</span>.<span title="tensorflow.data">data</span>.<span title="tf.data.Dataset">Dataset</span></code>)
        – <p>TensorFlow dataset of test data.</p>
      </li>
      <li class="field-body">
        <b>callbacks</b>
            (<code>list[<a class="autorefs autorefs-internal" title="solstice.trainer.Callback" href="#solstice.trainer.Callback">Callback</a>] | None</code>)
        – <p>List of Solstice callbacks. These
can execute arbitrary code on certain events, usually for side effects like
logging. See <code>solstice.Callback</code>. Defaults to None.</p>
      </li>
      <li class="field-body">
        <b>return_outs</b>
            (<code>bool</code>)
        – <p>If True, the auxiliary outputs from
<code>exp.eval_step()</code> are accumulated into a list and returned, else this
function returns nothing. Defaults to False.</p>
      </li>
  </ul>
      <div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Testing simply involves running through the test_ds for a single epoch. Thus
the <code>on_epoch_start()</code> and <code>on_epoch_end()</code> callback hooks are executed once
each, before testing starts and after testing ends.</p>
</div>

  <p>Returns:</p>
  <ul>
      <li class="field-body">
            <code>list[<span title="typing.Any">Any</span>] | None</code>
        – <p>list[Any] | None: List of auxiliary outputs from <code>exp.eval_step()</code> if
return_outs is True, else None.</p>
      </li>
  </ul>

      <details class="quote">
        <summary>Source code in <code>solstice/trainer.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">test</span><span class="p">(</span>
    <span class="n">exp</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span>
    <span class="n">test_ds</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callback</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_outs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test a `solstice.Experiment`, using `tf.data.Dataset` for data loading. Supply</span>
<span class="sd">    `solstice.Callback`s to add any additional functionality.</span>

<span class="sd">    Args:</span>
<span class="sd">        exp (Experiment): Experiment to test.</span>
<span class="sd">        test_ds (tf.data.Dataset): TensorFlow dataset of test data.</span>
<span class="sd">        callbacks (list[Callback] | None, optional): List of Solstice callbacks. These</span>
<span class="sd">            can execute arbitrary code on certain events, usually for side effects like</span>
<span class="sd">            logging. See `solstice.Callback`. Defaults to None.</span>
<span class="sd">        return_outs (bool, optional): If True, the auxiliary outputs from</span>
<span class="sd">            `exp.eval_step()` are accumulated into a list and returned, else this</span>
<span class="sd">            function returns nothing. Defaults to False.</span>

<span class="sd">    !!! tip</span>
<span class="sd">        Testing simply involves running through the test_ds for a single epoch. Thus</span>
<span class="sd">        the `on_epoch_start()` and `on_epoch_end()` callback hooks are executed once</span>
<span class="sd">        each, before testing starts and after testing ends.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[Any] | None: List of auxiliary outputs from `exp.eval_step()` if</span>
<span class="sd">            return_outs is True, else None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">return_outs</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span>
        <span class="s2">&quot;No callbacks were provided and return_outs is False. This function thus has no&quot;</span>
        <span class="s2">&quot; return vaules or side effects. All it does is heat up the planet :(&quot;</span>
    <span class="p">)</span>

    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>
    <span class="p">[</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">on_epoch_start</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">callbacks</span>
    <span class="p">]</span> <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">global_step</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">outputs_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">test_ds</span><span class="o">.</span><span class="n">as_numpy_iterator</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test_ds</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Testing&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;step&quot;</span>
    <span class="p">):</span>
        <span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="p">[</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">on_step_start</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">global_step</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span> <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">callbacks</span>
        <span class="p">]</span> <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">exp</span><span class="p">,</span> <span class="n">outs</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">eval_step</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">outputs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outs</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_outs</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="p">[</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">on_step_end</span><span class="p">(</span><span class="n">outs</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">global_step</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span> <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">callbacks</span>
        <span class="p">]</span> <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="p">[</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">on_epoch_end</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">callbacks</span>
    <span class="p">]</span> <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">outputs_list</span> <span class="k">if</span> <span class="n">return_outs</span> <span class="k">else</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div><h2 id="utilities">Utilities<a class="headerlink" href="#utilities" title="Permanent link">¤</a></h2>


<div class="doc doc-object doc-module">



  <div class="doc doc-contents first">
  
      <p>Miscellaneous utilities for Solstice.</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="solstice.utils.EarlyStoppingException" class="doc doc-heading">
        <code>EarlyStoppingException</code>


<a href="#solstice.utils.EarlyStoppingException" class="headerlink" title="Permanent link">¤</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code>Exception</code></p>

  
      <p>A callback can raise this exception <code>on_epoch_end</code> to break the training loop
early. Useful if you want to write a custom alternative to <code>EarlyStoppingCallback</code>.</p>


        <details class="quote">
          <summary>Source code in <code>solstice/utils.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">EarlyStoppingException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A callback can raise this exception `on_epoch_end` to break the training loop</span>
<span class="sd">    early. Useful if you want to write a custom alternative to `EarlyStoppingCallback`.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
        </details>

  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="solstice.utils.replace" class="doc doc-heading">
<code class="highlight language-python"><span class="n">replace</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Module</span></code>

<a href="#solstice.utils.replace" class="headerlink" title="Permanent link">¤</a></h3>


  <div class="doc doc-contents ">
  
      <p>Make out-of-place changes to a Module, returning a new module with changes
applied. Just a wrapper around <code>equinox.tree_at</code>.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>You can use this in the same way as <code>dataclasses.replace</code>, but it only works
with <code>eqx.Module</code>s. The advantage is that it can be used when custom <code>__init__</code>
constructors are defined.
For more info, see <a href="https://github.com/patrick-kidger/equinox/issues/120">https://github.com/patrick-kidger/equinox/issues/120</a>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">equinox</span> <span class="k">as</span> <span class="nn">eqx</span>
<span class="kn">import</span> <span class="nn">solstice</span>

<span class="k">class</span> <span class="nc">Counter</span><span class="p">(</span><span class="n">eqx</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># &#39;smart&#39; constructor inits x by calculating from z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">z</span>

    <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">solstice</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

<span class="n">C1</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">C1</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span>
<span class="n">C2</span> <span class="o">=</span> <span class="n">C1</span><span class="o">.</span><span class="n">increment</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">C2</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>
</div>

  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>obj</b>
            (<code><span title="solstice.utils.Module">Module</span></code>)
        – <p>Module to make changes to (subclass of <code>eqx.Module</code>).</p>
      </li>
      <li class="field-body">
        <b>**changes</b>
            (<code><span title="typing.Any">Any</span></code>)
        – <p>Keyword arguments to replace in the module.</p>
      </li>
  </ul>

  <p>Returns:</p>
  <ul>
      <li class="field-body">
<b>Module</b>(            <code><span title="solstice.utils.Module">Module</span></code>
)        – <p>New instance of <code>obj</code> with the changes applied.</p>
      </li>
  </ul>

      <details class="quote">
        <summary>Source code in <code>solstice/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Module</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Make out-of-place changes to a Module, returning a new module with changes</span>
<span class="sd">    applied. Just a wrapper around `equinox.tree_at`.</span>

<span class="sd">    !!! example</span>
<span class="sd">        You can use this in the same way as `dataclasses.replace`, but it only works</span>
<span class="sd">        with `eqx.Module`s. The advantage is that it can be used when custom `__init__`</span>
<span class="sd">        constructors are defined.</span>
<span class="sd">        For more info, see https://github.com/patrick-kidger/equinox/issues/120.</span>

<span class="sd">        ```python</span>

<span class="sd">        import equinox as eqx</span>
<span class="sd">        import solstice</span>

<span class="sd">        class Counter(eqx.Module):</span>
<span class="sd">            x: int</span>

<span class="sd">            def __init__(self, z: int):</span>
<span class="sd">                # &#39;smart&#39; constructor inits x by calculating from z</span>
<span class="sd">                self.x = 2 * z</span>

<span class="sd">            def increment(self):</span>
<span class="sd">                return solstice.replace(self, x=self.x+1)</span>

<span class="sd">        C1 = Counter(z=0)</span>
<span class="sd">        assert C1.x == 0</span>
<span class="sd">        C2 = C1.increment()</span>
<span class="sd">        assert C2.x == 1</span>
<span class="sd">        ```</span>

<span class="sd">    Args:</span>
<span class="sd">        obj (Module): Module to make changes to (subclass of `eqx.Module`).</span>
<span class="sd">        **changes (Any): Keyword arguments to replace in the module.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Module: New instance of `obj` with the changes applied.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">keys</span><span class="p">,</span> <span class="n">vals</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">changes</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">eqx</span><span class="o">.</span><span class="n">tree_at</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">],</span> <span class="n">obj</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../../from_flax_to_solstice/" class="md-footer__link md-footer__link--prev" aria-label="Previous: From flax to solstice" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              From flax to solstice
            </div>
          </div>
        </a>
      
      
        
        <a href="../../example_projects/" class="md-footer__link md-footer__link--next" aria-label="Next: Examples" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Examples
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "header.autohide", "content.code.annotate", "navigation.indexes", "navigation.instant"], "search": "../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
    
  </body>
</html>